---
title: "ã€GoÃ—gPRCã€‘æ›´æ–°ç³»ã®APIã«FieldMaskã‚’å°å…¥ã™ã‚‹å®Ÿè£…ä¾‹ã«ã¤ã„ã¦ç´¹ä»‹ã—ãŸã„"
emoji: "ğŸ§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

# å°å…¥

ã¿ãªã•ã‚“ã¯æ›´æ–°ç³»ã® API ã‚’ã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ ğŸ¤”

ã“ã“ã§è­°è«–ã—ãŸã„ã®ã¯ã€ç‰¹ã«ãƒªã‚½ãƒ¼ã‚¹ã®ä¸€éƒ¨åˆ†ã®ã¿ã‚’æ›´æ–°ã™ã‚‹ API ã«ãªã‚Šã¾ã™ã€‚
å¼Šç¤¾ã§ã‚‚ãã®ã‚ˆã†ãª API ã‚’ä½œã‚‹æ©Ÿä¼šãŒã‚ã‚Šã¾ã™ãŒã€ãã®éš›ã¯ã€Œå…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å—ã‘ä»˜ã‘ã‚‹ APIã€ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã—ãŸï¼
å€¤ã‚’å¤‰ãˆãŸã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ›´æ–°å¾Œã®å€¤ã‚’æ¸¡ã—ã€ãã†ã§ãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ç¾åœ¨ã®å€¤ã‚’æ¸¡ã™ã€ã¨ã„ã†ã‚ˆã†ãªä½¿ã„æ–¹ã«ãªã‚Šã¾ã™ã€‚

ä¸€æ–¹ã§ã€ä¸Šè¨˜ã®ã‚ˆã†ãª API ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå•é¡Œã‚’æŠ±ãˆã¦ã„ã¾ã™ âš ï¸

1. **ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€å…¨ã¦ã®å€¤ã‚’å–å¾—ã™ã‚‹å®Ÿè£…ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚‹**
1. **æ–°è¦ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ãŸã¨ãã«ã€å‘¼ã³å‡ºã—ã¦ã„ã‚‹å…¨ã¦ã®ãƒ•ãƒ­ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ãŒå¿…è¦ã«ãªã‚‹**

ã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚¹ã‚¯ï¼ˆFieldMaskï¼‰ã‚’å°å…¥ã—ã¾ã—ãŸï¼
äº‹å‰ã®èª¿æŸ»ã§ã€GoÃ—gRPC ã§ã® FieldMask ã®å®Ÿè£…äº‹ä¾‹ã¯å°‘ãªã„ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

ã“ã®ãƒ–ãƒ­ã‚°ã§ã¯å…·ä½“ä¾‹ã‚’äº¤ãˆã¦ã€FieldMask ã®å®Ÿè£…ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼

# FieldMask ã¨ã¯

ã•ã¦ã€å…·ä½“çš„ãŒå®Ÿè£…ä¾‹ã«å…¥ã‚‹å‰ã« FieldMask ã®èª¬æ˜ã‚’ç°¡å˜ã«è¡Œã„ãŸã„ã¨æ€ã„ã¾ã™ï¼

FieldMask ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« proto ãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

```proto
message FieldMask {
  // The set of field mask paths.
  repeated string paths = 1;
}
```

å®Ÿè£…ã¨ã—ã¦ã¯ã‚ã¡ã‚ƒã‚ã¡ã‚ƒã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ï¼

ãã—ã¦ã€ã‚³ãƒ¡ãƒ³ãƒˆã§ä»¥ä¸‹ã®ã‚ˆã†ã«èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ï¼ˆæœ€åˆã®æ•°è¡Œã®ã¿ã‚’æŠœç²‹ã—ã¦ã„ã¾ã™ï¼‰ã€‚

```proto
// `FieldMask` represents a set of symbolic field paths, for example:
//
//	paths: "f.a"
//	paths: "f.b.d"
//
// Here `f` represents a field in some root message, `a` and `b`
// fields in the message found in `f`, and `d` a field found in the
// message in `f.b`.
//
// Field masks are used to specify a subset of fields that should be
// returned by a get operation or modified by an update operation.
// Field masks also ...
```

æœ€åˆã® 1 åˆ†ã‚’ç›´è¨³ã™ã‚‹ã¨ã€Œ`FieldMask`ã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ‘ã‚¹ã®æŠ½è±¡çš„ãªé›†åˆã‚’è¡¨ç¾ã™ã‚‹ã€ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚
ä¾‹ãˆã°ã€`f.a` ã¨ã„ã† FieldMask ã®è¡¨ç¾ã¯ã€ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã® `f` ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸­ã«ã‚ã‚‹ `a` ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒ‡ã—ã¾ã™ã€‚

FieldMask ã¯ä¸»ã«ã€å–å¾—å‡¦ç†ã«ã‚ˆã£ã¦è¿”ã•ã‚Œã‚‹ã€ã‚ã‚‹ã„ã¯æ›´æ–°å‡¦ç†ã«ã‚ˆã£ã¦ä¿®æ­£ã•ã‚Œã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚µãƒ–ã‚»ãƒƒãƒˆã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

## æ›´æ–° API ã§ã®ä½¿ç”¨

ã§ã¯å®Ÿéš›ã«ã€**æ›´æ–°ç³»ã® API ã§ã¯ã©ã®ã‚ˆã†ã«ä½¿ç”¨ã™ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ**

Google ãŒå…¬é–‹ã—ã¦ã„ã‚‹ API ã®è¨­è¨ˆã‚¬ã‚¤ãƒ‰ã®[Update](https://google.aip.dev/134)ã®ãƒšãƒ¼ã‚¸ã«ãã®ä¸€ä¾‹ãŒè¼‰ã£ã¦ã„ã¾ã™ã€‚ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯ãƒšãƒ¼ã‚¸ã®ä¸€éƒ¨ã‚’æŠœç²‹ã—ãŸã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

```proto
message UpdateBookRequest {
  // The book to update.
  //
  // The book's `name` field is used to identify the book to update.
  // Format: publishers/{publisher}/books/{book}
  Book book = 1 [(google.api.field_behavior) = REQUIRED];

  // The list of fields to update.
  google.protobuf.FieldMask update_mask = 2;
}
```

`UpdateBookRequest` ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€æ›´æ–°å¯¾è±¡ã§ã‚ã‚‹ `Book` ã¨ã€ã©ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°ã™ã‚‹ã‹ã® `FieldMask` ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

**æ›´æ–°ã—ãŸã„å¯¾è±¡ã®ãƒªã‚½ãƒ¼ã‚¹ã¨ã€ãƒªã‚½ãƒ¼ã‚¹ã®ã©ã®éƒ¨åˆ†ã‚’æ›´æ–°ã™ã‚‹ã‹ã®æƒ…å ±ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦æ¸¡ã›ã°è‰¯ã„**ã€ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ï¼

[Update](https://google.aip.dev/134)ã®ãƒšãƒ¼ã‚¸ã«ã¯ã€ãã®ã»ã‹ã«ã‚‚æ§˜ã€…ãªã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ãŒã€ä¸€æ—¦ãã¡ã‚‰ã¯ç„¡è¦–ã—ã¦ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…ã‚’è€ƒãˆã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ï¼

# å®Ÿè£…ã®ç´¹ä»‹

## å…¨ä½“æ§‹é€ 

ã„ã‚ˆã„ã‚ˆã€å…·ä½“çš„ãªå®Ÿè£…ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼

å…¨ä½“çš„ãªæ§‹é€ ã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ ã‚’è€ƒãˆã¦ã¿ã¾ã™ã€‚

1. presenter å±¤ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ã‘ä»˜ã‘ã‚‹
   - FieldMask ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã‚’è¡Œã†
1. usecase å±¤ãŒ repository å±¤ã®æ›´æ–°å‡¦ç†ã‚’å‘¼ã¶
   - æ›´æ–°ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ repository ã«æ¸¡ã™
   - repository ã§ã¯æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ›´æ–°ã‚’è¡Œã†

æ›´æ–° API ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ä¸‹è¨˜ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã™ã€‚

```proto
message UpdateCompanyRequest {
  // æ›´æ–°å¯¾è±¡
  UpdateCompany company = 1;
  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚¹ã‚¯
  google.protobuf.FieldMask update_mask = 2;

  message UpdateCompany {
    // ä¼šç¤¾ID
    int32 id = 1;
    // ä¼šç¤¾å
    string name = 2;
    // ä½æ‰€
    string address = 3;
    // è¨­ç«‹æ—¥
    google.protobuf.Timestamp established_at = 4;
  }
}
```

## presenter å±¤ã®å®Ÿè£…

presenter å±¤ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã‚’è¡Œã„ã¾ã—ãŸ

```go
func (s *Server) UpdateCompany(ctx context.Context, req *v1.UpdateCompanyRequest) (*v1.UpdateCompanyResponse, error) {
	updateMask := req.GetUpdateMask()
	if updateMask == nil {
		return nil, errors.New("update mask should be specified")
	}

	updateMask.Normalize()
	if !updateMask.IsValid(&v1.UpdateCompanyRequest_UpdateCompany{}) {
		return nil, errors.New("update_mask is invalid")
	}

	updateFields, err := toUpdateFields(updateMask.GetPaths())
	if err != nil {
		return nil, fmt.Error("failed to convert update mask to entity")
	}

  // usecaseã‚’å‘¼ã³å‡ºã™å‡¦ç†
}
```

å¤§äº‹ãªã®ã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã™ï¼

```go
	updateMask.Normalize()
	if !updateMask.IsValid(&v1.UpdateCompanyRequest_UpdateCompany{}) {
		return nil, errors.New("update_mask is invalid")
	}

  updateFields, err := toUpdateFields(updateMask.GetPaths())
	if err != nil {
		return nil, fmt.Error("failed to convert update mask to entity")
	}
```

`Normalize()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯

## usecase å±¤ã®å®Ÿè£…

## repository å±¤ã®å®Ÿè£…

# ã¾ã¨ã‚

# å°å…¥

Go1.24ãŒå°å…¥ã•ã‚Œã€

# 
