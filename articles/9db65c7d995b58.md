---
title: "SLOのアラートの設定について真面目に考えてみる"
emoji: "👻"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

信頼性に関する目標 (SLO) に基づくアラート設定について、考慮すべき点と具体的なアラート設定方法をまとめてみました。

今回のブログで紹介している内容は [サイトリライアビリティワークブック -SRE の実践方法](https://www.oreilly.co.jp//books/9784873119137/) の「5 章 SLO に基づくアラート」に基づいた内容になっています！

# 対象

- SLO、SLI、エラーバジェットに関する知識は持っていること
- SLO のアラートの設定方法について詳しく学びたい方

# アラートに関する考慮事項

さて、上記で紹介した本ではアラートを設定する際、以下の項目を考慮することが重要だと言及されています。

| 項目                            | 説明                                                                                                                                  |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| Precision（適合率）             | - 検知されたイベントのうち、重要なイベントの割合 <br> - すべてのアラートが重要なイベントに対応する場合、100%となる                    |
| Recall（再現率、真陽性率、TPR） | - 検知された重要なイベントの割合 <br> - 全ての重要なイベントがアラートになれば、100%となる                                            |
| Detection time（検知時間）      | - 様々な条件下で通知を送信するのにかかる時間 <br> - 検知時間が長いとエラーバジェットに悪影響がある                                    |
| Reset time（リセット時間）      | - 実際の問題が解決した後もアラートが発火状態になっている時間 <br>- リセット時間が長いと、混乱したり問題が無視されたりする可能性がある |

適合率と再現率のが少しわかりにくい概念なので、具体例を出して説明してみます。

100 回のイベントのうち、エラーイベントが 10 回発生したケースで考えてみましょう。

| 設定したアラートの検知結果 | 適合率                                       | 再現率                                                        |
| -------------------------- | -------------------------------------------- | ------------------------------------------------------------- |
| 100 回アラートが発火した   | 重要なイベントは 10 回のみなので 10%（低い） | 10 回のイベントが全て検知できているので 100%                  |
| 5 回アラートが発火した     | 5 回とも全て重要なイベントなので 100%        | 10 回の重要なイベントのうち、5 回しか検知できていないので 50% |

適合率と再現率の考え方としては上記の表のような形になります。少しわかりやすくなったのではないでしょうか？

# アラートの設定方法

ここからは具体的なアラートの設定方法について、[サイトリライアビリティワークブック -SRE の実践方法](https://www.oreilly.co.jp//books/9784873119137/) の「5 章 SLO に基づくアラート」で紹介されている 6 つの方法について順に説明していきます！

## 1. 「エラー率 ≥ SLO の閾値」とするアラート

短い時間窓（time window）でエラー率が SLO の閾値を超過した場合にアラートを発火させる方法です。

具体例として以下のような設定を考えてみます。

| SLO   | 期間  | イベント数 | エラーバジェット |
| ----- | ----- | ---------- | ---------------- |
| 99.9% | 30 日 | 100 回/分  | 4320 回          |

アラートの設定は以下のようにしてみます。

- **5 分間で 0.1 %のエラー率の場合にアラートを発火**

以下のようなタイムラインでエラーが起こったとします

| 時刻  | エラー数 | 5 分の time window 内でのエラー数 | エラー率 (%) | アラートの状態 |
| ----- | -------- | --------------------------------- | ------------ | -------------- |
| 19:00 | 0        | 0                                 | 0.00         | OK             |
| 19:01 | 0        | 0                                 | 0.00         | OK             |
| 19:02 | 0        | 0                                 | 0.00         | OK             |
| 19:03 | 0        | 0                                 | 0.00         | OK             |
| 19:04 | 1        | 1                                 | 0.10         | **ALERT**      |
| 19:05 | 2        | 3                                 | 0.30         | **ALERT**      |
| 19:06 | 1        | 4                                 | 0.40         | **ALERT**      |
| 19:07 | 1        | 5                                 | 0.50         | **ALERT**      |
| 19:08 | 0        | 5                                 | 0.50         | **ALERT**      |
| 19:09 | 0        | 4                                 | 0.40         | **ALERT**      |
| 19:10 | 0        | 2                                 | 0.20         | **ALERT**      |
| 19:11 | 0        | 1                                 | 0.10         | **ALERT**      |
| 19:12 | 0        | 0                                 | 0.00         | **ALERT**      |
| 19:13 | 0        | 0                                 | 0.00         | **ALERT**      |
| 19:14 | 0        | 0                                 | 0.00         | **ALERT**      |
| 19:15 | 0        | 0                                 | 0.00         | **ALERT**      |
| 19:16 | 0        | 0                                 | 0.00         | **ALERT**      |
| 19:17 | 0        | 0                                 | 0.00         | OK             |
| 19:18 | 0        | 0                                 | 0.00         | OK             |
| 19:19 | 0        | 0                                 | 0.00         | OK             |
| 19:20 | 0        | 0                                 | 0.00         | OK             |
| 19:21 | 0        | 0                                 | 0.00         | OK             |
| 19:22 | 0        | 0                                 | 0.00         | OK             |
| 19:23 | 0        | 0                                 | 0.00         | OK             |
| 19:24 | 0        | 0                                 | 0.00         | OK             |
| 19:25 | 0        | 0                                 | 0.00         | OK             |

タイムラインをまとめてみると以下のようになります。

- 最初のエラーが起こった時点でアラートが発火する
- 閾値を下回った時刻（19:11）から 6 分後にアラートの状態が OK に戻る

上記のようなアラートの Pros/Cons をまとめてみます。

- メリット (Pros) 👍

  - 検知時間が短い
  - 再現率が高い
    - SLO を脅かす可能性のあるイベントを全て捕捉できる

- デメリット (Cons) 👎
  - 適合率が低い
    - 多くのイベントでアラートが発火するが、そのほとんどが SLO を脅かすものではない可能性がある
    - 今回のケースだとエラー数が 5 回に対して、許容されているエラー数が 4320 回なので、エラーバジェットはほとんど消費されていない

## 2. 「アラートが発火する時間ウィンドウを伸ばす」

アラートが発火する時間ウィンドウを長く設定し、エラーバジェットの消費量が一定の割合に達した場合にアラートを発火させる方法です。

具体例として以下のような設定を考えてみます。

| SLO   | 期間  | イベント数 | エラーバジェット |
| ----- | ----- | ---------- | ---------------- |
| 99.9% | 30 日 | 1000 回/分 | 43200 回         |

アラートの設定は以下のようにしてみます。

- **30 日間のエラーバジェットの 5%を消費するイベントの場合にアラート（継続した場合、約 36 時間で消費）**

| 時刻  | エラー数 | エラー数 (window) | エラー率 (%) | アラート状態                          |
| ----- | -------- | ----------------- | ------------ | ------------------------------------- |
| 19:00 | 0        | 0                 | 0.00         | OK                                    |
| 19:01 | 0        | 0                 | 0.00         | OK                                    |
| 19:02 | 0        | 0                 | 0.00         | OK                                    |
| 19:03 | 0        | 0                 | 0.00         | OK                                    |
| 19:04 | 50       | 50                | 0.02         | OK                                    |
| 19:05 | 50       | 100               | 0.05         | OK                                    |
| 19:06 | 50       | 150               | 0.07         | OK                                    |
| 19:07 | 50       | 200               | 0.09         | OK                                    |
| 19:08 | 50       | 250               | 0.12         | ALERT                                 |
| 19:09 | 0        | 250               | 0.12         | ALERT                                 |
| 19:10 | 0        | 250               | 0.12         | ALERT                                 |
| 19:11 | 0        | 250               | 0.12         | ALERT                                 |
| 19:12 | 0        | 250               | 0.12         | ALERT                                 |
| 19:13 | 0        | 250               | 0.12         | ALERT                                 |
| 19:14 | 0        | 250               | 0.12         | ALERT                                 |
| 19:15 | 0        | 250               | 0.12         | ALERT                                 |
| 19:16 | 0        | 250               | 0.12         | ALERT                                 |
| ...   | ...      | ...               | ...          | 36 時間経過するまでずっとアラート状態 |

Google スプレッドシートにエクスポート
Pros 👍:

適合率が方法 1 より良い: より重大なエラーバジェットの消費を検知するため、誤報が減ります。

検知時間は短い: ある程度の持続的なエラー率であれば、比較的早く検知できます。

Cons 👎:

リセット時間が長い: アラートが長時間発火状態になりやすく、問題解決後もアラートが解除されるまでに時間がかかることがあります。

3. アラート期間の延長
   モニタリングシステムが提供する「継続期間」のパラメータを伸ばす方法です。これにより、短いスパイク的なエラーではなく、一定期間持続するエラーのみを検知します。

具体例:

SLO: 稼働率 99.9%（30 日で 1 分あたり 100 イベント発生、エラーバジェット 4320 回）

アラート設定: 1 分間のエラーレートが 0.1%を超え、その状態が 1 時間継続する場合にアラートを発火（window は 5 分）

時刻

エラー数

window 内のエラー数

エラー率 (%)

19:00

0

0

0.00

...

...

...

...

19:04

80

80

16.00

19:05

80

160

32.00

19:06

80

240

48.00

19:07

80

320

64.00

19:08

80

400

80.00

...

...

...

...

19:59

80

400

80.00

20:04

-

-

-

Google スプレッドシートにエクスポート
Pros 👍:

適合率が高い: 短時間で収束する一時的な問題ではなく、持続的な問題を検知するため誤報が減ります。

Cons 👎:

再現率が悪い: スパイク的にエラー率が断続的に続く場合、継続期間の条件を満たさないため検知できない可能性があります。

検知時間が悪い: 上記の例では、実際にエラーが発生してからアラートが発動するまでに 1 時間かかるため、対応が遅れる可能性があります。

4. バーンレートに対するアラート
   エラーバジェットが枯渇するまでの時間（バーンレート）に基づいてアラートを設定する方法です。短い検知時間で高い適合率のアラートを実現することを目指します。

バーンレートの計算式:
バーンレートは、現在のエラー消費速度が続いた場合に、SLO の期間中にエラーバジェットを何倍の速さで使い切ってしまうかを示す指標です。

エラーバジェットが枯渇するまでの時間:

$$\text{エラーバジェットが枯渇するまでの時間} = \frac{100\%}{\text{エラーバジェット消費率（%）}} \times \text{計算時間}$$
バーンレート（単位なし）:

$$\text{バーンレート} = \frac{\text{SLO目標の長さ（時間）} \times \text{エラーバジェット消費率（%）}}{\text{ウィンドウ（時間）} \times 100\%}$$
例: SLO 目標 7 日、1 時間のウィンドウでエラーバジェットが 10%消費される場合

1 時間 ×100%
7 日 ×24 時間 ×10%
​
=16.8
具体例:

SLO: 稼働率 99.9%（30 日で 1 分あたり 100 イベント発生、エラーバジェット 4320 回）

アラート設定: 1 時間で 30 日のエラーバジェットの 5%を消費するとアラートを発火

時刻

エラー数

エラー数 (window)

エラーバジェット消費率 (%)

バーンレート

IsAlert

19:00

0

0

0.00

0

OK

19:01

0

0

0.00

0

OK

19:02

0

0

0.00

0

OK

19:03

0

0

0.00

0

OK

19:04

30

30

0.69

5

OK

19:05

30

60

1.39

10

OK

19:06

30

90

2.08

15

OK

19:07

30

120

2.78

20

OK

19:08

30

150

3.47

25

OK

19:09

30

180

4.17

30

OK

19:10

30

210

4.86

35

OK

19:11

30

240

5.56

40

ALERT

19:12

0

240

5.56

40

ALERT

...

...

...

...

...

...

Google スプレッドシートにエクスポート
Pros 👍:

良い適合率: エラーバジェットの消費に着目するため、意味のあるアラートにつながりやすいです。

短い time window（計算コストが低い）: 比較的短い期間で計算が完結します。

検知時間が短い: エラーバジェットが急速に消費されている場合に迅速に検知できます。

Cons 👎:

リセット時間が長い: エラーバジェットの消費率が低下しても、アラートが解除されるまでに時間がかかることがあります。

バーンレートの解釈: 上記の例でバーンレートが 35 の場合、実際には 30 日のエラーバジェットを約 20.5 時間で使い切ってしまう計算になりますが、このバーンレート自体がアラートの閾値として適切かどうかの判断は別途必要です。

5. 複数のバーンレートアラートの設置
   複数の異なるバーンレートと時間ウィンドウを組み合わせてアラートを設定する方法です。これにより、重要度や状況に応じて適切なアラートを発動させることができます。

30 日のエラーバジェットの場合の例:

エラーバジェット消費

time window

バーンレート

通知先

2%

1 時間

14.4

Page

5%

6 時間

6

Page

10%

3 日

1

Ticket

Google スプレッドシートにエクスポート
Pros 👍:

重要度に応じた監視: エラー率が高い場合は迅速にアラートを発火し、エラー率が低くても持続する場合は最終的にアラートを発火させることができます。

良い適合率: より具体的なエラーバジェットの消費目標に紐づくため、誤報が減ります。

良い再現率: 3 日の長いウィンドウを設けることで、いずれは枯渇するであろうエラーバジェットの消費にも気づけます。

Cons 👎:

管理が煩雑になる: 設定する数値、ウィンドウサイズ、閾値が増えるため、管理が複雑になります。

リセット時間が長い: 特に 3 日のウィンドウのアラートが設定されている場合、リセット時間が長くなる可能性があります。

複数のアラートが同時に発火する可能性: 例えば、5 分で予算の 10%を消費するような事態は、6 時間で 5%消費、1 時間で 2%消費という条件も同時に満たしてしまうため、複数のアラートが同時に発火する可能性があります。

6. 複数のウィンドウ、複数のバーンレートアラートの設置
   方法 5 の利点を活かしつつ、誤報を減らし、リセット時間を短縮できる、より洗練された方法です。

考え方:
短いウィンドウ（例：5 分、30 分）を導入し、アラートが発火するときに、その短いウィンドウ内でエラーバジェットが実際に消費され続けているかをチェックします。
これにより、一時的なスパイクによる誤報を減らし、問題が解決した際のリセット時間を短縮できます。

一方で、長いウィンドウ（例：1 時間、6 時間、3 日間）では、より長い期間におけるエラー率とバーンレートを評価し、エラーバジェットがどの程度の速度で消費されているかを判断します。

この 2 つの条件（短いウィンドウでの継続的なエラーと、長いウィンドウでのバーンレート消費）が同時に満たされた場合のみアラートを発火させることで、適合率と再現率の両方を高めます。

また、異なる深刻度のアラートを OR 条件で組み合わせることで、どれか 1 つの条件を満たせばアラートを発火させつつ、複数のアラートが同時に通知される可能性を減らすことができます。

深刻度別の複合アラートの例:

深刻度

長いウィンドウ

短いウィンドウ

バーンレート

消費されたエラーバジェット

通知先

Page

1 時間

5 分

14.4

2%

Page

Page

6 時間

30 分

6

5%

Page

Ticket

3 日

6 時間

1

10%

Ticket

Google スプレッドシートにエクスポート
Pros 👍:

方法 5 の Pros: 重要度に応じた監視、高い適合率と再現率を維持できます。

複数アラートの同時発火を防ぐ: 短いウィンドウでの確認を組み合わせることで、本当に対応が必要なアラートに絞り込めます。

適合率が高い: 短いウィンドウでの確認により、誤報が大幅に削減されます。

リセット時間が短い: 問題が解決すると短いウィンドウでのエラーがなくなるため、迅速にアラートが解除されます。

Cons 👎:

設定が複雑になる傾向があります。

まとめ
SLO に基づくアラート設定は、サービスの信頼性を高め、運用チームの効率を向上させる上で非常に重要です。上記で紹介したアラート設定方法は、それぞれのメリットとデメリットがあります。あなたのサービスの特性、許容できるリスク、運用チームのキャパシティなどを考慮し、最適なアラート戦略を構築してください。
