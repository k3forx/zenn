---
title: "SLOのアラート設定を完全理解：6つの方法とDatadogでの設定まで徹底解説"
emoji: "🚨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["slo", "sre"]
published: false
---

信頼性に関する目標 (SLO) に基づくアラート設定について、考慮すべき点と具体的なアラート設定方法をまとめてみました。

今回のブログで紹介している内容は [サイトリライアビリティワークブック -SRE の実践方法](https://www.oreilly.co.jp//books/9784873119137/) の「5 章 SLO に基づくアラート」に基づいた内容になっています！

:::message
紹介するアラートの設定やメリット・デメリットは原文のものをほとんどそのまま引用しています。一方で、なぜその値を使うのか、なぜこのようなアラート設定にするのかについては筆者独自の解釈が入っていることを前置きしておきます。
:::

## 対象

- SLO、SLI、エラーバジェットに関する知識は持っている方
- SLO のアラートの設定方法について詳しく学びたい方

## アラートに関する考慮事項

さて、上記で紹介した本ではアラートを設定する際、以下の項目を考慮することが重要だと言及されています。

| 項目                            | 説明                                                                                                                                  |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| Precision（適合率）             | - 検知されたイベントのうち、重要なイベントの割合 <br> - すべてのアラートが重要なイベントに対応する場合、100%となる                    |
| Recall（再現率、真陽性率、TPR） | - 検知された重要なイベントの割合 <br> - 全ての重要なイベントがアラートになれば、100%となる                                            |
| Detection time（検知時間）      | - 様々な条件下で通知を送信するのにかかる時間 <br> - 検知時間が長いとエラーバジェットに悪影響がある                                    |
| Reset time（リセット時間）      | - 実際の問題が解決した後もアラートが発火状態になっている時間 <br>- リセット時間が長いと、混乱したり問題が無視されたりする可能性がある |

適合率と再現率が少しわかりにくい概念なので、具体例を出して説明してみます。

100 回のイベントのうち、エラーイベントが 10 回発生したケースで考えてみましょう。

| 設定したアラートの検知結果 | 適合率                                       | 再現率                                                        |
| -------------------------- | -------------------------------------------- | ------------------------------------------------------------- |
| 100 回アラートが発火した   | 重要なイベントは 10 回のみなので 10%（低い） | 10 回のイベントが全て検知できているので 100%                  |
| 5 回アラートが発火した     | 5 回とも全て重要なイベントなので 100%        | 10 回の重要なイベントのうち、5 回しか検知できていないので 50% |

適合率と再現率の考え方としては上記の表のような形になります。少しわかりやすくなったのではないでしょうか？

## 分かりやすく説明するために

本ブログでは SLO のアラート設定をより具体的な例で考えるために以下のような状況を仮定しています。

### SLO やイベントの設定

| SLO   | 期間  | イベント数 |
| ----- | ----- | ---------- |
| 99.9% | 30 日 | 100 回/分  |

ちなみにエラーバジェットは 0.1%なので、イベント数に換算すると 4320 回（= 100 × 60 × 24 × 30 × 0.001）になります。

### アラートの設定やエラー率の計算方法

下記のタイムラインでエラーが起こったとします。

| 時刻  | エラー数 |
| ----- | -------- |
| 19:00 | 0        |
| 19:01 | 0        |
| 19:02 | 1        |
| 19:03 | 10       |
| 19:04 | 7        |
| 19:05 | 1        |
| 19:06 | 0        |
| 19:07 | 0        |

アラートの評価期間（time window）を 3 分とした場合、**「time window 内のエラー数はその時刻を含む、過去 3 分間のエラー数の合計」** とします。データがない部分は 0 として扱います。
つまり、19:02 での time window あたりのエラー数は 19:00 ~ 19:02 までのエラー数を合計した値の 1（0 + 0 + 1）になります。

| 時刻  | エラー数 | time window 内のエラー数 |
| ----- | -------- | ------------------------ |
| 19:00 | 0        | 0                        |
| 19:01 | 0        | 0                        |
| 19:02 | 1        | 1 （= 0 + 0 + 1）        |
| 19:03 | 10       | 11（= 0 + 1 + 10）       |
| 19:04 | 7        | 18（= 1 + 10 + 7）       |
| 19:05 | 1        | 18（= 10 + 7 + 1）       |
| 19:06 | 0        | 8 （= 7 + 1 + 0）        |
| 19:07 | 0        | 1 （= 1 + 0 + 0）        |

---

続いて、エラー率（％）は以下の式で計算します。

$$
\frac{\text{time window}内のエラー数}{\text{time window}内のイベント数の合計} \times 100
$$

先ほどの表に列を追加してみます。

| 時刻  | エラー数 | time window 内のエラー数 | エラー率（%）            |
| ----- | -------- | ------------------------ | ------------------------ |
| 19:00 | 0        | 0                        | 0.00（= 0 ÷ 300 × 100）  |
| 19:01 | 0        | 0                        | 0.00（= 0 ÷ 300 × 100）  |
| 19:02 | 1        | 1                        | 0.33（= 1 ÷ 300 × 100）  |
| 19:03 | 10       | 11                       | 3.67（= 11 ÷ 300 × 100） |
| 19:04 | 7        | 18                       | 6.00（= 18 ÷ 300 × 100） |
| 19:05 | 1        | 18                       | 6.00（= 18 ÷ 300 × 100） |
| 19:06 | 0        | 8                        | 2.67（= 8 ÷ 300 × 100）  |
| 19:07 | 0        | 1                        | 0.33（= 1 ÷ 300 × 100）  |

## 6 つのアラートの設定方法

ここからは具体的なアラートの設定方法について、[サイトリライアビリティワークブック -SRE の実践方法](https://www.oreilly.co.jp//books/9784873119137/) の「5 章 SLO に基づくアラート」で紹介されている 6 つの方法について順に説明していきます！

### 1. 「エラー率 ≥ SLO の閾値」とするアラート

短い時間窓（time window）でエラー率が SLO の閾値を超過した場合にアラートを発火させる方法です（もっともシンプルな設定です）。

具体例として以下のような設定を考えてみます。

アラートの設定は以下のようにしてみます。

- **5 分間で 0.1 %のエラー率の場合にアラートを発火**

以下のようなタイムラインでエラーが起こったとします

| 時刻  | エラー数 | 5 分の time window 内でのエラー数 | エラー率 (%) | アラートの状態 |
| ----- | -------- | --------------------------------- | ------------ | -------------- |
| 19:00 | 0        | 0                                 | 0.00         | OK             |
| 19:01 | 0        | 0                                 | 0.00         | OK             |
| 19:02 | 0        | 0                                 | 0.00         | OK             |
| 19:03 | 0        | 0                                 | 0.00         | OK             |
| 19:04 | 1        | 1                                 | 0.20         | **ALERT**      |
| 19:05 | 2        | 3                                 | 0.60         | **ALERT**      |
| 19:06 | 1        | 4                                 | 0.80         | **ALERT**      |
| 19:07 | 1        | 5                                 | 1.00         | **ALERT**      |
| 19:08 | 0        | 5                                 | 1.00         | **ALERT**      |
| 19:09 | 0        | 4                                 | 0.80         | **ALERT**      |
| 19:10 | 0        | 2                                 | 0.40         | **ALERT**      |
| 19:11 | 0        | 1                                 | 0.20         | **ALERT**      |
| 19:12 | 0        | 0                                 | 0.00         | OK             |
| 19:13 | 0        | 0                                 | 0.00         | OK             |
| 19:14 | 0        | 0                                 | 0.00         | OK             |
| 19:15 | 0        | 0                                 | 0.00         | OK             |
| 19:16 | 0        | 0                                 | 0.00         | OK             |
| 19:17 | 0        | 0                                 | 0.00         | OK             |
| 19:18 | 0        | 0                                 | 0.00         | OK             |
| 19:25 | 0        | 0                                 | 0.00         | OK             |

タイムラインをまとめてみると以下のようになります。

- 最初のエラーが起こった時点でアラートが発火する
- エラーが 0 になった時刻（19:08）から 3 分後にアラートの状態が OK に戻る

上記のようなアラートの Pros/Cons をまとめてみます。

- メリット (Pros) 👍

  - 検知時間が短い
  - 再現率が高い
    - SLO を脅かす可能性のあるイベントを全て捕捉できる

- デメリット (Cons) 👎
  - 適合率が低い
    - 多くのイベントでアラートが発火するが、そのほとんどが SLO を脅かすものではない可能性がある
    - 今回のケースだとエラー数が 5 回に対して、許容されているエラー数が 4320 回なので、エラーバジェットはほとんど消費されていない

### 2. 「アラートの評価期間（time window）を伸ばす」アラート

1 の「エラー率 ≥ SLO の閾値」の方法では **エラーバジェットに余裕があるのにアラートの状態が ALERT になっていました。**
そこで「このエラー率が続くとエラーバジェットが枯渇しそうな場合に ALERT 状態にする」方法を考えてみます。

具体的には、アラートの評価期間（time window）を長く設定し、エラーバジェットの消費量が一定の割合に達した場合にアラートを発火させる方法です。

アラートの設定は以下のようにしてみます。

- **30 日間のエラーバジェットの 5% を消費するイベントの場合にアラート**

「5%」というのは一見するとエラーバジェットが枯渇しそうな値ではないですが、「5%」という値になるまでの時間が論点になってきます。
例えば、24（時間）× 30（日）× 0.05 = 36（時間）で「5%」のエラーバジェットを消費した場合、30 日後にはエラーバジェットが 100％消費される計算になります。**「36 時間で 5% のエラーバジェット消費」** というのは十分アラートに値する基準値となります。

---

上記の条件をエラー数やエラー率の観点から言い換えてみましょう。

100 回/分のイベント数の場合、30 日間における 99.9%の SLO に対するエラーバジェットは 4320 回 になります。つまり、エラーバジェットの 5%は 216 回です。

36 時間で 216 回のエラーが起こったときのエラー率を計算してみます：

- 36 時間の総イベント数: 100 回/分 × 60 分 × 36 時間 = 216,000 回
- エラー率: 216 ÷ 216,000 × 100 = 0.1%

つまり、「36 時間で 5% のエラーバジェット消費」は「36 時間で 0.1% のエラー率」と同じ条件になります。先ほどのアラートの設定を言い換えると

- 36 時間の time window でエラー率が 0.1%を超えたら ALERT 状態にする

となります。

具体的なタイムラインで考えてみると以下のようになります。

| 時刻  | エラー数 | 36 時間の time window 内でのエラー数 | エラー率 (%) | アラートの状態                        |
| ----- | -------- | ------------------------------------ | ------------ | ------------------------------------- |
| 19:00 | 0        | 0                                    | 0.00         | OK                                    |
| 19:01 | 0        | 0                                    | 0.00         | OK                                    |
| 19:02 | 0        | 0                                    | 0.00         | OK                                    |
| 19:03 | 0        | 0                                    | 0.00         | OK                                    |
| 19:04 | 50       | 50                                   | 0.02         | OK                                    |
| 19:05 | 50       | 100                                  | 0.05         | OK                                    |
| 19:06 | 50       | 150                                  | 0.07         | OK                                    |
| 19:07 | 50       | 200                                  | 0.09         | OK                                    |
| 19:08 | 50       | 250                                  | 0.12         | ALERT                                 |
| 19:09 | 0        | 250                                  | 0.12         | ALERT                                 |
| 19:10 | 0        | 250                                  | 0.12         | ALERT                                 |
| 19:11 | 0        | 250                                  | 0.12         | ALERT                                 |
| 19:12 | 0        | 250                                  | 0.12         | ALERT                                 |
| 19:13 | 0        | 250                                  | 0.12         | ALERT                                 |
| 19:14 | 0        | 250                                  | 0.12         | ALERT                                 |
| 19:15 | 0        | 250                                  | 0.12         | ALERT                                 |
| 19:16 | 0        | 250                                  | 0.12         | ALERT                                 |
| ...   | ...      | ...                                  | ...          | 36 時間経過するまでずっとアラート状態 |

タイムラインをまとめてみると以下のようになります。

- 最初のエラーが起こった時点（19:04）から 4 分後にアラートの状態が ALERT になる
- アラートの状態が ALERT になってから、36 時間後に状態が OK に戻る

上記のようなアラートの Pros/Cons をまとめてみます。

- メリット (Pros) 👍
  - 適合率が方法 1 より良い
    - より重大なエラーバジェットの消費を検知するため、誤報が減る
  - 検知時間は短い
    - ある程度の持続的なエラー率であれば、比較的早く検知できる
- デメリット（Cons）👎
  - リセット時間が長い
    - アラートが長時間発火状態になりやすく、問題解決後もアラートが解除されるまでに時間がかかることがある
  - パフォーマンスの問題がある
    - 長時間の time window で値を計算することはたくさんのデータ量を扱う必要があるため

### 3. 「アラート期間の延長」を行う方法

2 のアラート設定方法のデメリットとして「リセット時間が長いこと」や「多くのデータを扱うことによるパフォーマンスの問題」が挙げられていました。
リセット時間を短くしつつ、一定数のエラーバジェットの消費に気づくためにはどのような設定を行えば良いのでしょうか？

3 つ目の方法では、モニタリングシステムが提供する「継続期間」のパラメータを伸ばす方法を考えてみます。

アラートの設定は以下のようにしてみます。

- **エラー率が 0.1%を超え、その状態が 1 時間継続する場合に ALERT 状態にする（time window は 5 分）**

具体的なタイムラインで考えてみると以下のようになります。

| 時刻  | エラー数 | 5 分の time window 内でのエラー数 | エラー率 (%) | アラートの状態                      |
| ----- | -------- | --------------------------------- | ------------ | ----------------------------------- |
| 19:00 | 0        | 0                                 | 0.00         | OK                                  |
| 19:01 | 0        | 0                                 | 0.00         | OK                                  |
| 19:02 | 0        | 0                                 | 0.00         | OK                                  |
| 19:03 | 0        | 0                                 | 0.00         | OK                                  |
| 19:04 | 80       | 80                                | 16.00        | OK                                  |
| 19:05 | 80       | 160                               | 32.00        | OK                                  |
| 19:06 | 80       | 240                               | 48.00        | OK                                  |
| 19:07 | 80       | 320                               | 64.00        | OK                                  |
| 19:08 | 80       | 400                               | 80.00        | OK                                  |
| 19:09 | 80       | 400                               | 80.00        | OK                                  |
| 19:10 | 80       | 400                               | 80.00        | OK                                  |
| 19:11 | 80       | 400                               | 80.00        | OK                                  |
| ...   | ...      | ...                               | ...          | 上記の状態が 1 時間継続すれば ALERT |

タイムラインをまとめてみると以下のようになります。

- 19:04 以降エラー率は 16%以上となっているが、アラート状態が ALERT になるのは 1 時間後

上記のようなアラートの Pros/Cons をまとめてみます。

- メリット (Pros) 👍
  - 適合率が高い
    - 短時間で収束する一時的な問題ではなく、持続的な問題を検知するため誤報が減る
- デメリット（Cons）👎
  - 再現率が悪い
    - スパイク的にエラー率が断続的に続く場合、継続期間の条件を満たさないため検知できない可能性がある
  - 検知時間が悪い
    - 上記の例では、実際にエラーが発生してからアラートが発動するまでに 1 時間かかるため、対応が遅れる可能性がある

### バーンレートの導入

1 ~ 3 で紹介した方法では、高い適合率を維持したまま、検知時間を短くすることができませんでした。

ここで登場するのが **バーンレート** という概念になります。このバーンレートを用いることで、短い検知時間で高い適合率のアラートを実現することが可能になります。バーンレートを使ったアラートの設定を紹介する前に、バーンレートの理解を深めておきましょう。

まずは言葉の定義からです。
バーンレートは **「SLO に対して、どれくらいの速さでエラーバジェットを消費しているかを示す値」** です。

バーンレートが 1 の場合、SLO の目標期間（30 日）でエラーバジェットが 0 になる計算です。バーンレートが 2 の場合、1 の 2 倍のスピードでエラーバジェットが消費されるということになり、0 になるまでの時間は 30 日（SLO の目標期間）÷ 2 = 15 日 となります。

表にまとめると以下のようになります（SLO の目標期間は 30 日で 99.9%）。

| バーンレート | 99.9% SLO のエラー率 | エラーバジェットが 0 になるまでの時間 |
| ------------ | -------------------- | ------------------------------------- |
| 1            | 0.1%                 | 30 日                                 |
| 2            | 0.2%                 | 15 日                                 |
| 10           | 1%                   | 3 日                                  |
| 1000         | 100%                 | 43 分                                 |

上記の定義を数式として書き起こすと以下のようになります。

$$
\frac{SLOの目標期間}{バーンレート} = エラーバジェットが0になるまでの時間 \tag{1}
$$

---

さて、ここで **エラーバジェットが 0 になるまでの時間** をより深く考えてみましょう。

エラーバジェットが 0 になる = エラーバジェットが 100%消費される、ということなので、「エラーバジェットが 0 になるまでの時間」は以下のように計算できるはずです。

$$
\begin{align*}
エラーバジェットが 0 になるまでの時間 &= \frac{100\%}{単位時間あたりのエラーバジェットの消費率（\%）} \\
&= \frac{100\%}{\frac{エラーバジェットの消費率（％）}{消費率の計算時間（ウィンドウ）}} \\
&= \frac{100\%}{\text{エラーバジェット消費率（％）}} \times \text{消費率の計算時間（ウィンドウ）}
\end{align*}
$$

上記の式を(1)の右辺に代入し、変形していくと以下のような数式が導き出せます。

$$
\text{バーンレート} = \frac{\text{SLOの目標期間（時間）} \times \text{エラーバジェット消費率（\%）}}{\text{ウィンドウ（時間）} \times 100\%}
$$

---

この式をどう解釈すると良いでしょうか？

SLO の目標期間は固定であることが多いので、アラートとして設定する時に考慮する必要があるのは **エラーバジェットの消費率（％）** と **ウィンドウ（時間）** の 2 点になります。

つまり **「バーンレートはある time window の中でどれだけのエラーバジェット消費率を許容できるか（できないか）」** を定量的に示す指標だと解釈できます。

### 4. バーンレートに対するアラート

バーンレートに関する説明がある程度終わったところで、実際にバーンレートを使用したアラートの設定についてみていきます。

アラートの設定は、2 のアラートの設定のように「30 日間のエラーバジェットの 5% を消費するイベントの場合にアラート」としつつ、3 のアラートように「1 時間継続した場合にアラート」としてみます。

まとめると下記のような設定でアラートの設定を行います。

- **30 日間のエラーバジェットの 5%が 1 時間の間に消費される**

SLO の目標期間は 30 日、time window は 1 時間、エラーバジェットの消費率が 5%なので、バーンレートは以下のように計算できます。

$$
\text{バーンレート} = \frac{\text{SLOの目標期間（時間）} \times \text{エラーバジェット消費率（\%）}}{\text{ウィンドウ（時間）} \times 100\%} = \frac{30 \times 24（時間）\times 5％}{1（時間） \times 100％} = 36
$$

具体的なタイムラインで考えてみると以下のようになります。

| 時刻  | エラー数 | 1 時間の time window 内のエラー数 | エラーバジェット消費率 (%) | バーンレート | アラートの状態 |
| ----- | -------- | --------------------------------- | -------------------------- | ------------ | -------------- |
| 19:00 | 0        | 0                                 | 0.00                       | 0            | OK             |
| 19:01 | 0        | 0                                 | 0.00                       | 0            | OK             |
| 19:02 | 0        | 0                                 | 0.00                       | 0            | OK             |
| 19:03 | 0        | 0                                 | 0.00                       | 0            | OK             |
| 19:04 | 30       | 30                                | 0.69                       | 5            | OK             |
| 19:05 | 30       | 60                                | 1.39                       | 10           | OK             |
| 19:06 | 30       | 90                                | 2.08                       | 15           | OK             |
| 19:07 | 30       | 120                               | 2.78                       | 20           | OK             |
| 19:08 | 30       | 150                               | 3.47                       | 25           | OK             |
| 19:09 | 30       | 180                               | 4.17                       | 30           | OK             |
| 19:10 | 30       | 210                               | 4.86                       | 35           | OK             |
| 19:11 | 30       | 240                               | 5.56                       | 40           | ALERT          |
| 19:12 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:13 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:14 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:15 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:16 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:17 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:18 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:19 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:20 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:21 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:22 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:23 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:24 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:25 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:26 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:27 | 0        | 240                               | 5.56                       | 40           | ALERT          |
| 19:28 | 0        | 240                               | 5.56                       | 40           | ALERT          |

タイムラインをまとめると以下のようになります。

- 19:04 にエラーが発生して、7 分後に ALERT 状態になる
- ALERT 状態になってから 1 時間後に OK 状態になる

上記のようなアラートの Pros/Cons をまとめてみます。

- メリット (Pros) 👍
  - 良い適合率
    - エラーバジェットの消費に着目するため、意味のあるアラートにつながりやすい
  - 短い time window（計算コストが低い）
  - 比較的短い期間で計算が完結する
- デメリット（Cons）👎
  - リセット時間が長い
    - エラーバジェットの消費率が低下しても、アラートが解除されるまでに時間がかかることがある
    - 今回のケースだと 1 時間近くかかる
  - バーンレートの解釈
    - 上記の例でバーンレートが 35 の場合、実際には 30 日のエラーバジェットを約 20.5 時間で使い切ってしまう計算になるが、今回設定したアラートでは気づくことができない

### 5. 複数のバーンレートアラートの設置

4 の方法だと「バーンレートは低いが、そのままの状態だとエラーバジェットを使い切る状態」に気づくことができませんでした。

そこで、複数の異なるバーンレートと time window を組み合わせてアラートを設定することにより、重要度や状況に応じて適切なアラートを発動させることを考えてみます。

[サイトリライアビリティワークブック -SRE の実践方法](https://www.oreilly.co.jp//books/9784873119137/) には以下の設定例が記載されています。

| エラーバジェット消費 | time window | バーンレート | 通知先 |
| -------------------- | ----------- | ------------ | ------ |
| 2%                   | 1 時間      | 14.4         | Page   |
| 5%                   | 6 時間      | 6            | Page   |
| 10%                  | 3 日        | 1            | Ticket |

表のようなバーンレートに対してアラートを設定し、下記のようなタイムラインでエラーが起こったとします。
アラート 1 がバーンレート 14.4、アラート 2 がバーンレート 6、アラート 3 がバーンレート 1 に対応しています。

| 時刻  | エラー数 | エラー数 (window) | エラーバジェット消費率 (%) | バーンレート | アラート 1 の状態 | アラート 2 の状態 | アラート 3 の状態 |
| ----- | -------- | ----------------- | -------------------------- | ------------ | ----------------- | ----------------- | ----------------- |
| 19:00 | 0        | 0                 | 0.00                       | 0.0          | OK                | OK                | OK                |
| 19:01 | 0        | 0                 | 0.00                       | 0.0          | OK                | OK                | OK                |
| 19:02 | 0        | 0                 | 0.00                       | 0.0          | OK                | OK                | OK                |
| 19:03 | 0        | 0                 | 0.00                       | 0.0          | OK                | OK                | OK                |
| 19:04 | 1        | 1                 | 0.02                       | 0.2          | OK                | OK                | OK                |
| 19:05 | 3        | 4                 | 0.09                       | 0.7          | OK                | OK                | OK                |
| 19:06 | 5        | 9                 | 0.21                       | 1.5          | OK                | OK                | ALERT             |
| 19:07 | 7        | 16                | 0.37                       | 2.7          | OK                | OK                | ALERT             |
| 19:08 | 9        | 25                | 0.58                       | 4.2          | OK                | OK                | ALERT             |
| 19:09 | 11       | 36                | 0.83                       | 6.0          | OK                | ALERT             | ALERT             |
| 19:10 | 13       | 49                | 1.13                       | 8.2          | OK                | ALERT             | ALERT             |
| 19:11 | 15       | 64                | 1.48                       | 10.7         | OK                | ALERT             | ALERT             |
| 19:12 | 17       | 81                | 1.88                       | 13.5         | OK                | ALERT             | ALERT             |
| 19:13 | 19       | 100               | 2.31                       | 16.7         | ALERT             | ALERT             | ALERT             |
| 19:14 | 0        | 100               | 2.31                       | 16.7         | ALERT             | ALERT             | ALERT             |
| 19:15 | 0        | 100               | 2.31                       | 16.7         | ALERT             | ALERT             | ALERT             |
| 19:16 | 0        | 100               | 2.31                       | 16.7         | ALERT             | ALERT             | ALERT             |
| 19:17 | 0        | 100               | 2.31                       | 16.7         | ALERT             | ALERT             | ALERT             |
| 19:18 | 0        | 100               | 2.31                       | 16.7         | ALERT             | ALERT             | ALERT             |

タイムラインをまとめると以下のようになっています。

- 19:04 にエラーが発生し、19:06 にアラート 3 が ALERT 状態になる
- 19:09 にアラート 2 が ALERT 状態になる
- 19:13 にアラート 1 が ALERT 状態になる

方法 4 で問題になっていた、バーンレートが低い場合に検知できない問題はひとまず解消できています。

このような複数のアラートを設定する方法の Pros/Cons をまとめてみます。

- メリット (Pros) 👍
  - 重要度に応じた監視
    - エラー率が高い場合は迅速にアラートを発火し、エラー率が低くても持続する場合は最終的にアラートを発火させることができる
  - 良い適合率
    - より具体的なエラーバジェットの消費目標に紐づくため誤報が減る
  - 良い再現率
    - 3 日の長いウィンドウを設けることで、いずれは枯渇するであろうエラーバジェットの消費にも気づける
- デメリット（Cons）👎
  - 管理が煩雑になる
    - 設定する数値、ウィンドウサイズ、閾値が増えるため、管理が複雑になる
  - リセット時間が長い
    - 特に 3 日のウィンドウのアラートが設定されている場合、リセット時間が長くなる可能性がある
  - 複数のアラートが同時に発火する可能性
    - 例えば、上記の例ではすべてのアラートが同時に ALERT 状態になっている

### 6. 複数のウィンドウ、複数のバーンレートアラートの設置

この方法は、方法 5 の利点を活かしつつ、誤報を減らしリセット時間を短縮できる、より洗練された方法になります。

考え方として以下のようになります。

- 短いウィンドウ（例: 5 分）を導入し、アラートが発火するときに、その短いウィンドウ内でエラーバジェットが実際に消費され続けているかをチェックする
  - 一時的なスパイクによる誤報を減らし、問題が解決した際のリセット時間を短縮できる
- 長いウィンドウ（例: 1 時間）では、より長い期間におけるエラー率とバーンレートを評価し、エラーバジェットがどの程度の速度で消費されているかを判断する

上記の 2 つの条件（短いウィンドウでの継続的なエラーと、長いウィンドウでのバーンレート消費）が同時に満たされた場合のみアラートを発火させることで、適合率と再現率の両方を高める方法になります。

また、異なる深刻度のアラートを `OR` 条件で組み合わせることで、どれか 1 つの条件を満たせばアラートを発火させつつ、複数のアラートが同時に通知される可能性を減らすことができます。

[サイトリライアビリティワークブック -SRE の実践方法](https://www.oreilly.co.jp//books/9784873119137/) には以下の設定例が記載されています。

| 深刻度 | 長いウィンドウ | 短いウィンドウ | バーンレート | 消費されたエラーバジェット |
| ------ | -------------- | -------------- | ------------ | -------------------------- |
| Page   | 1 時間         | 5 分           | 14.4         | 2%                         |
| Page   | 6 時間         | 30 分          | 6            | 5%                         |
| Ticket | 3 日           | 6 時間         | 1            | 10%                        |

以下のようなタイムラインでエラーが起こったとします。アラートの状態はバーンレート 14.4 のケースを示しています。

| 時刻  | エラー数 | エラー数 (short window) | エラー数 (long window) | エラーバジェット消費率 (%) short window | エラーバジェット消費率 (%) long window | バーンレート（short） | バーンレート（long） | アラートの状態 |
| ----- | -------- | ----------------------- | ---------------------- | --------------------------------------- | -------------------------------------- | --------------------- | -------------------- | -------------- |
| 19:00 | 0        | 0                       | 0                      | 0.000                                   | 0.00                                   | 0.0                   | 0.00                 | OK             |
| 19:01 | 0        | 0                       | 0                      | 0.000                                   | 0.00                                   | 0.0                   | 0.00                 | OK             |
| 19:02 | 0        | 0                       | 0                      | 0.000                                   | 0.00                                   | 0.0                   | 0.00                 | OK             |
| 19:03 | 0        | 0                       | 0                      | 0.000                                   | 0.00                                   | 0.0                   | 0.00                 | OK             |
| 19:04 | 0        | 0                       | 0                      | 0.000                                   | 0.00                                   | 0.0                   | 0.00                 | OK             |
| 19:05 | 20       | 20                      | 20                     | 0.463                                   | 0.46                                   | 40.0                  | 3.33                 | OK             |
| 19:06 | 20       | 40                      | 40                     | 0.926                                   | 0.93                                   | 80.0                  | 6.67                 | OK             |
| 19:07 | 20       | 60                      | 60                     | 1.389                                   | 1.39                                   | 120.0                 | 10.00                | OK             |
| 19:08 | 20       | 80                      | 80                     | 1.852                                   | 1.85                                   | 160.0                 | 13.33                | OK             |
| 19:09 | 20       | 100                     | 100                    | 2.315                                   | 2.31                                   | 200.0                 | 16.67                | ALERT          |
| 19:10 | 20       | 100                     | 120                    | 2.315                                   | 2.78                                   | 200.0                 | 20.00                | ALERT          |
| 19:11 | 20       | 100                     | 140                    | 2.315                                   | 3.24                                   | 200.0                 | 23.33                | ALERT          |
| 19:12 | 20       | 100                     | 160                    | 2.315                                   | 3.70                                   | 200.0                 | 26.67                | ALERT          |
| 19:13 | 20       | 100                     | 180                    | 2.315                                   | 4.17                                   | 200.0                 | 30.00                | ALERT          |
| 19:14 | 20       | 100                     | 200                    | 2.315                                   | 4.63                                   | 200.0                 | 33.33                | ALERT          |
| 19:15 | 20       | 100                     | 220                    | 2.315                                   | 5.09                                   | 200.0                 | 36.67                | ALERT          |
| 19:16 | 0        | 80                      | 220                    | 1.852                                   | 5.09                                   | 160.0                 | 36.67                | OK             |
| 19:17 | 0        | 60                      | 220                    | 1.389                                   | 5.09                                   | 120                   | 36.67                | OK             |
| 19:18 | 0        | 40                      | 220                    | 0.926                                   | 5.09                                   | 80                    | 36.67                | OK             |
| 19:19 | 0        | 20                      | 220                    | 0.463                                   | 5.09                                   | 40                    | 36.67                | OK             |
| 19:20 | 0        | 0                       | 220                    | 0.000                                   | 5.09                                   | 0                     | 36.67                | OK             |
| 19:21 | 0        | 0                       | 220                    | 0.000                                   | 5.09                                   | 0                     | 36.67                | OK             |
| 19:22 | 0        | 0                       | 220                    | 0.000                                   | 5.09                                   | 0                     | 36.67                | OK             |

タイムラインをまとめると以下のようになっています。

- 19:05 からエラーが発生し、19:09 には ALERT 状態になる
- 19:16 でエラーが発生しなくなり、同時刻に OK 状態に戻る

アラートの Pros/Cons をまとめてみます。

- メリット (Pros) 👍
  - 方法 5 の Pros
    - 重要度に応じた監視、高い適合率と再現率を維持できる
  - 複数アラートの同時発火を防ぐ
    - 短いウィンドウでの確認を組み合わせることで、本当に対応が必要なアラートに絞り込める
  - 適合率が高い
    - 短いウィンドウでの確認により、誤報が大幅に削減される
  - リセット時間が短い
    - 問題が解決すると短いウィンドウでのエラーがなくなるため、迅速にアラートが解除される
- デメリット（Cons）👎
  - 設定が複雑になる傾向がある（方法 5 の Cons と同じ）

## Datadog でのアラートの設定の仕方

### 複数のウィンドウ、複数のバーンレートアラートの設定

Datadog では方法 6 のアラートの設定を行うことができるようになっています。

Datadog のモニターを作成する画面から「SLO」を選択します。

![](https://storage.googleapis.com/zenn-user-upload/4030aeb688e3-20250716.png)

使用する SLO を選択し「Burn Rate」でのアラート設定を選択すると、下記のような画面に切り替わります。

![](https://storage.googleapis.com/zenn-user-upload/51b218ebe1fe-20250716.png)

長い time window を調整すると、短い time window が自動的に計算されるようになっています。この方法によって、方法 6 の「 複数のウィンドウ、複数のバーンレートアラートの設置」が可能になっています

### Composite アラートの設定

方法 6 のアラートでは、複数の time window に合わせて複数のアラートを作成する必要がありました。さらに、複数アラートが同時に ALERT 状態になるのを防ぐために、Composite アラートを設定するのが推奨されていました。

Datadog では上記を設定するには、モニターを作成する画面から「Composite」を選択します。

![](https://storage.googleapis.com/zenn-user-upload/6ea32498c688-20250716.png)

先ほど設定したバーンレートのアラートを選択し、アラートの発火条件を `a || b` などで指定します。

![](https://storage.googleapis.com/zenn-user-upload/cccaec877816-20250716.png)

上記のように設定することで、複数のアラートが同時に ALERT 状態になることを防ぐことができます。

## まとめ

SLO に基づくアラート設定は、サービスの信頼性を高め、運用チームの効率を向上させる上で非常に重要です。

一方で、[サイトリライアビリティワークブック -SRE の実践方法](https://www.oreilly.co.jp//books/9784873119137/)を 1 度読んだだけでは 6 つのアラートの設定を理解することは難しかったです（少なくとも筆者は）。

今回のブログでは具体的な SLO の設定やイベント、エラーを仮定することによって、より詳細にアラートの設定の仕方や考え方を深めることができたかと思います。

## 参考文献

筆者がアラート設定やバーンレートの考え方などを学ぶにあたって参考にした文献の一覧になります。

- [サイトリライアビリティワークブック -SRE の実践方法](https://www.oreilly.co.jp//books/9784873119137/)
  - [Prometheus Alerting: Turn SLOs into Alerts](https://sre.google/workbook/alerting-on-slos/)
- [分類: 精度、再現率、適合率、関連する指標](https://developers.google.com/machine-learning/crash-course/classification/accuracy-precision-recall?hl=ja)
- [お客さま影響に基づく実践的なアラート方法](https://engineering.mercari.com/blog/entry/20211215-practical_alerting_methods_based_on_customer_impact/)
- [Burn rate is a better error rate](https://www.datadoghq.com/blog/burn-rate-is-better-error-rate/)
- [Proactively monitor service performance with SLO alerts](https://www.datadoghq.com/blog/monitor-service-performance-with-slo-alerts/)
- [Key questions to ask when setting SLOs](https://www.datadoghq.com/blog/slo-key-questions/)
- [Best practices for managing your SLOs with Datadog](https://www.datadoghq.com/blog/define-and-manage-slos/#choosing-the-best-slo-for-each-use-case)
