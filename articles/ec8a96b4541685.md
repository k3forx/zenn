---
title: "ã€Go1.24ã€‘testing/synctestãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã¿ãŸã„ã‚“ã˜ã‚ƒã€œ"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

# å°å…¥

Go1.24 ãŒ 2025 å¹´ 2 æœˆã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸ ğŸ‰ğŸ‰ğŸ‰

å‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã«å¯¾å¿œã—ãŸã‚Šã€map ã®å®Ÿè£…ãŒ Swiss Table ã«ãªã£ãŸã‚Šã¨ç´°ã‹ãªæ”¹å–„ãŒè¡Œã‚ã‚Œã¾ã—ãŸï¼

ä»Šå›ã¯ã“ã®ä¸­ã‹ã‚‰ã€å®Ÿé¨“çš„ã«å°å…¥ã•ã‚ŒãŸ [testing/synctest](https://pkg.go.dev/testing/synctest) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã¤ã„ã¦ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼

ã“ã®è¨˜äº‹ã§ã¯ã€testing/synctest ã§å®Ÿè£…ã•ã‚ŒãŸ 2 ã¤ã® API ã‚’ç´¹ä»‹ã—ã¤ã¤ã€**GoDoc ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å…·ä½“çš„ãªä»•æ§˜**ã«ã¤ã„ã¦ã‚‚è§¦ã‚ŒãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

# å®Ÿè£…ã•ã‚ŒãŸèƒŒæ™¯

ãã‚‚ãã‚‚ãªãœã€testing/synctest ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå°å…¥ã•ã‚ŒãŸã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**ã€Œä¸¦åˆ—ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã€flakly ãªãƒ†ã‚¹ãƒˆã«ãªã‚ŠãŒã¡ã€** ã¨ã„ã†èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«å®Ÿè£…ã•ã‚ŒãŸã€ã¨ã„ã†ã®ãŒå›ç­”ã«ãªã‚Šã¾ã™ï¼

flaky ãªãƒ†ã‚¹ãƒˆã¨ã¯ã€å®Ÿè¡Œæ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ ã§è½ã¡ã¦ã—ã¾ã†ãƒ†ã‚¹ãƒˆã®ã“ã¨ã§ã™ã€‚
ã“ã®å¾Œã®ç« ã§ã€å®Ÿéš›ã«æ™‚é–“ãŒã‹ã‹ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ãŸã‚Šã€flaky ãªãƒ†ã‚¹ãƒˆã‚’å†ç¾ã—ã¦ã¿ã‚ˆã†ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

ãã—ã¦ã€å®Ÿéš›ã« testing/synctest ã‚’å°å…¥ã™ã‚‹ã“ã¨ã§ã€ä¸Šè¨˜ã®èª²é¡ŒãŒè§£æ±ºã™ã‚‹ã“ã¨ã‚‚ç¢ºã‹ã‚ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ ğŸ™Œ

# å®Ÿéš›ã«è©¦ã—ã¦ã¿ã‚‹ï¼

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã§ä½¿ç”¨ã™ã‚‹ Go ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ 1.24.0 ã«ãªã‚Šã¾ã™ã€‚

```bash
â¯ go version
go version go1.24.0 darwin/arm64
```

ã¾ãŸ VSCode ã§å®Ÿéš›ã«è©¦ã—ã¦ã¿ãŸã„æ–¹ã¯ã€ä¸‹è¨˜ã®è¨­å®šã‚’ `setting.json` ã«è¿½åŠ ã—ã¦ã¿ã¦ãã ã•ã„ ğŸ™†â€â™‚ï¸

```json
{
  "go.toolsEnvVars": {
    "GOEXPERIMENT": "synctest"
  }
}
```

## å®Ÿé¨“ 1: ç°¡å˜ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥

ã¾ãšã¯ä¸‹è¨˜ã®ã‚ˆã†ãªç°¡å˜ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¾‹ã§è€ƒãˆã¦ã¿ã¾ã™ã€‚

```go
package main

import (
	"time"
)

func NewCache[T any]() *Cache[T] {
	return &Cache[T]{}
}

type Cache[T any] struct {
	v       T
	ttl     time.Duration
	setTime time.Time
}

func (c *Cache[T]) Set(value T, ttl time.Duration) {
	c.v = value
	c.ttl = ttl
	c.setTime = time.Now()
}

func (c *Cache[T]) Get() T {
	if time.Since(c.setTime) >= c.ttl {
		var zero T
		return zero
	}
	return c.v
}
```

`Set` ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸã„å€¤ã¨ TTL ã‚’æ¸¡ã—ã¾ã™ã€‚`Get`ã¯è‡ªèº«ãŒå‘¼ã°ã‚ŒãŸæ™‚ã€TTL ã§æŒ‡å®šã—ãŸæ™‚é–“ãŒçµŒéã—ã¦ã„ãŸå ´åˆã¯ã‚¼ãƒ­å€¤ã‚’è¿”ã—ã€çµŒéã™ã‚‹å‰ã®å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸå€¤ã‚’è¿”ã—ã¾ã™ã€‚

ã‚ãˆã¦æ™‚é–“ã‚’ã‹ã‹ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ããŸã„ã®ã§ã€TTL ã‚’ 5 ç§’ã¨ã—ã€ãƒ†ã‚¹ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã¿ã¾ã™ã€‚

```go
package main

import (
	"testing"
	"time"
)

func TestCache_Get(t *testing.T) {
	ttl := 5 * time.Second
	cache := NewCache[string]()
	cache.Set("cached item", ttl)

	if got := cache.Get(); got != "cached item" {
		t.Errorf("expected 'cached item'; got %v", got)
	}

	time.Sleep(ttl)

	if got := cache.Get(); got != "" {
		t.Errorf("expected ''; got %v", got)
	}
}
```

å®Ÿè¡Œã—ã¦ã¿ã¾ã™ï¼

```bash
â¯ GOEXPERIMENT=synctest go test -run "TestCache_Get"
PASS
ok      github.com/k3forx/go124 5.229s
```

å½“ãŸã‚Šå‰ã§ã™ãŒã€5 ç§’ä»¥ä¸Šã‹ã‹ã‚‹ãƒ†ã‚¹ãƒˆã«ãªã£ã¦ã„ã¾ã™ ğŸ˜¢

### `Run` é–¢æ•°ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆæ™‚é–“ã‚’çŸ­ãã™ã‚‹

ã“ã“ã§ç™»å ´ã™ã‚‹ã®ãŒ testing/synctest ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã® `Run` é–¢æ•°ã§ã™ï¼

**`Run` é–¢æ•°ã§å…ˆã»ã©ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ Wrap ã™ã‚‹**ã ã‘ã§ã™ã€‚

```go
func TestCache_Get(t *testing.T) {
	synctest.Run(func() {
		ttl := 5 * time.Second
		cache := NewCache[string]()
		cache.Set("cached item", ttl)

		if got := cache.Get(); got != "cached item" {
			t.Errorf("expected 'cached item'; got %v", got)
		}

		time.Sleep(ttl)

		if got := cache.Get(); got != "" {
			t.Errorf("expected ''; got %v", got)
		}
	})
}
```

å®Ÿè¡Œã—ã¦ã¿ã¾ã™ï¼

```bash
â¯ GOEXPERIMENT=synctest go test -run "TestCache_Get"
PASS
ok      github.com/k3forx/go124 0.245s
```

å®Ÿè¡Œæ™‚é–“ãŒ `5.229s` ã‹ã‚‰ `0.245s` ã«æ¸›ã‚Šã¾ã—ãŸï¼ ğŸ‰ğŸ‰ğŸ‰

### `Run` é–¢æ•°ã® GoDoc ã‚’è¦‹ã¦ã¿ã‚‹ï¼

ã•ã¦ã€`Run` é–¢æ•°ã¯ã©ã®ã‚ˆã†ãªæŒ™å‹•ã«ãªã£ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ï¼ˆã©ã†ã„ã†ãƒ­ã‚¸ãƒƒã‚¯ã«ã‚ˆã£ã¦ã€ãƒ†ã‚¹ãƒˆã®æ™‚é–“ãŒçŸ­ç¸®ã•ã‚Œã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿï¼‰

GoDoc ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã† ğŸ‘€

```bash
â¯ GOEXPERIMENT=synctest go doc testing/synctest.Run
package synctest // import "testing/synctest"

func Run(f func())
    Run executes f in a new goroutine.

    The new goroutine and any goroutines transitively started by it form an
    isolated "bubble". Run waits for all goroutines in the bubble to exit before
    returning.

    Goroutines in the bubble use a synthetic time implementation. The initial
    time is midnight UTC 2000-01-01.

    Time advances when every goroutine in the bubble is blocked. For example,
    a call to time.Sleep will block until all other goroutines are blocked and
    return after the bubble's clock has advanced. See Wait for the specific
    definition of blocked.

    If every goroutine is blocked and there are no timers scheduled, Run panics.

    Channels, time.Timers, and time.Tickers created within the bubble are
    associated with it. Operating on a bubbled channel, timer, or ticker from
    outside the bubble panics.
```

ç­†è€…ãŒç¿»è¨³ã—ãŸã‚‚ã®ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

## å®Ÿé¨“ 2: ç°¡å˜ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ v2

## ãŠã•ã‚‰ã„ï¼ˆGo ã‚¯ã‚¤ã‚ºï¼ï¼‰

# ã¾ã¨ã‚
